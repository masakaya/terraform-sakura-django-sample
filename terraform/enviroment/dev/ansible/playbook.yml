---
- name: Update apt package
  become: true
  hosts: all
  vars_files:
    - vars/common.yml
  gather_facts: false

  tasks:
    # 共通処理
    - name: Common settings
      ansible.builtin.import_role:
        name: common
  vars:
    ansible_ssh_private_key_file: "{{ ssh_key_path }}"

- name: Deploy web system
  become: true
  vars_files:
    - vars/ssl.yml
    - vars/nfs.yml
    - vars/common.yml
    - vars/zabbix.yml
    - vars/lb.yml
  hosts: web
  gather_facts: true

  tasks:
    # Web Serverのセッティング
    - name: Webserver Setting
      ansible.builtin.import_role:
        name: web
   
    - name: Zabbix agent Setting
      ansible.builtin.import_role:
        name: community.zabbix.zabbix_agent
      vars:
        zabbix_agent_hostname: "Web Server"
        zabbix_agent_server: "{{ local_zabbix_agent_server }}"
        zabbix_agent_serveractive: "{{ local_zabbix_agent_serveractive }}"
  tags: 
  - "web"
  vars:
    ansible_ssh_private_key_file: "{{ ssh_key_path }}"

- name: Setting database server
  become: true
  vars_files:
    - vars/common.yml
    - vars/zabbix.yml
    - roles/db/vars/postgresql.yml
    - roles/db/vars/root.yml
    - roles/db/vars/user.yml
  hosts: db
  gather_facts: true
  tasks:
    - name: Database Setting
      ansible.builtin.import_role:
        name: db
    
    - name: Zabbix agent Setting
      ansible.builtin.import_role:
        name: community.zabbix.zabbix_agent
      vars:
        zabbix_agent_hostname: "Database Server"
        zabbix_agent_server: "{{ local_zabbix_agent_server }}"
        zabbix_agent_serveractive: "{{ local_zabbix_agent_serveractive }}"
  tags:
  - "db"
  vars:
    ansible_ssh_private_key_file: "{{ ssh_key_path }}"



- name: Setup management server
  become: true
  vars_files:
    - vars/nfs.yml
    - vars/common.yml
    - vars/lb.yml
    - roles/mng/vars/zabbix_server.yml
    - roles/mng/vars/zabbix_database.yml
  hosts: mng 
  gather_facts: true
  tasks:
    - name: Database Setting
      ansible.builtin.import_role:
        name: mng
  tags: 
  - "mng"
  vars:
    ansible_ssh_private_key_file: "{{ ssh_key_path }}"
    ansible_os_family: "Ubuntu"