# Zabbix 7.0 設定マニュアル

## 目次:
1. サーバ自動追加設定
2. Web監視
3. ODBC監視（DB監視）
4. ディスク監視
5. ログ監視
6. Slack通知

## 1. サーバ自動追加設定

### 前提条件:
- Zabbix 7.0がインストールされていること
- 自動検出ルールを設定するための権限があること

### 手順:

#### 1. アクションの設定(既存ルール有効化)
1. 通知 > アクション > ディスカバリアクション に移動します。
2. 「Auto discovery. Linux servers.」を「無効」をクリックし、「有効」します。

#### 2. 自動検出ルールの作成(既存ルール有効化)
1. データ収集 > ディスカバリ に移動します。
2. ディスカバリルールから「Local network」を無効をクリックし、「有効」とします。

## 2. Web監視

### 前提条件:
- ローカルネットワークから監視対象のWebサイトにアクセスできること

### 手順:

#### 1. Web シナリオの作成
1. データ収集 > ホスト に移動します。
2. 対象のホスト(192.168.0.10)の「Web」リンクをクリックします。
3. 「Web シナリオの作成」をクリックします。
4. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます(例：Web監視(192.168.0.10))
   - 監視間隔: チェックの頻度を設定します(例：1m)
   - 試行回数：1
   - エージェント: Zabbix
5. 「ステップの追加」をクリックします。
6. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます(例：Web監視(192.168.0.10))
   - URL: http://192.168.0.10:81 (※水平スケールした場合は異なるIPを設定すること)
   - 要求ステータスコード：200
   - エージェント: Zabbix
7. 「追加」をクリックして保存します。

## 3. ODBC監視（DB監視）

### 1. 前提条件
- 監視対象のデータベースサーバーが稼働していること
- ODBCドライバーがインストールされていること

### 2. アイテムの作成
1. ホストの画面を開く
2. データ収集 > ホスト > アイテムを選択する
3. 「アイテムの作成」 をクリックする
4. 以下の設定を行う:
   - 名前: わかりやすい名前を付ける（Ex. Postgresql host）
   - タイプ: データベースモニタ
   - キー: `db.odbc.select[DB_ALIVE_TEST,TEST_PSQL]`と入れてください
   - データ型: 数値
   - ユーザー名: データベースへの接続ユーザー
   - パスワード: データベースへの接続パスワード
   - SQLクエリ: 実行したいSQLクエリを入力（`SELECT 1;`）
   - 監視間隔：`1m`
5. [追加] をクリックして保存

### 3. テストと確認
1. 作成したアイテムの [テスト] ボタンをクリックする
2. テスト結果を確認し、正しく値が取得できることを確認する（`1`という値くること）

### 4. トリガーの設定（オプション）
1. データ収集 > ホスト > トリガーを選択する
2. `トリガーの作成` をクリックする
3. 新規トリガーでは以下を入力する
	1. アイテム :「アイテムの作成にて追加したデータ」
	2. 関数：`last()`
	3. 結果： `<>` `1`
d. [追加] をクリックして保存

### 5. グラフの作成（オプション）
1. データ収集 > ホスト > グラフを選択する
2. 「グラフの作成」 をクリックする
3. 作成したアイテムを選択し、グラフの設定を行う
4. [追加] をクリックして保存

### 7. ダッシュボードへの追加（オプション）
1. 「ダッシュボード」> 「追加」 に移動する
2. ウィジェットの追加で以下のを設定する
	1. タイプ： グラフ
	2. 名前：わかりやすい名前（Ex. DB死活監視)
	3. ホストパターン：データベースサーバーを選択（192.168.1.20）
	4. アイタムパターン：「アイテムの作成にて追加したデータ」
3. 「追加」する

## 4. ディスク監視

### 前提条件:
- 監視対象のサーバにZabbix Agentがインストールされていること
- Linuxテンプレートが適用されていること(自動追加時の設定 Linux Servers. がつくように設定していること)

### 手順:

(事前条件のテンプレートにて監視設定が入っている)

Linux by Zabbix agentにて以下の監視が行われるようになっている。
- クリティカル：90%
- ワーニング  ：80%

## 5. ログ監視

### 前提条件:
Zabbix監視サーバーにはsyslogサーバーにて各サーバーからログが収集されること

例：
  Webサーバー(Nginx) : server:{監視サーバー}:514 /var/log/rsyslog/nginx/access.log

### 手順（例）:

#### 1. アイテムの作成(Nginxログの場合)
1. 設定 > ホストに移動し、監視サーバー(Zabbix Server)を選択します。
2. アイテム タブをクリックし、「アイテムの作成」をクリックします。
3. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます
   - タイプ: Zabbixエージェント(アクティブ)
   - キー: logrt[/var/log/rsyslog/nginx/access.log,<条件>] (監視対象のログファイルパスを指定)
   - ※細かな設定は以下のURLを参照のこと
https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/log_items

4. 「追加」をクリックして保存します。

#### 2. トリガーの設定
1. トリガー タブをクリックし、「トリガーの作成」をクリックします。
2. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます
   - 深刻度：状態に合わせること
   - 式: `find(/Zabbix server/logrt["/var/log/rsyslog/nginx/access.log"],2m,"like",404)=1` 404が含まれていることを検知する
3. 「追加」をクリックして保存します。

## 6. Slack通知

### 前提条件:
- Slackワークスペースとチャンネルが準備されていること

### 手順:

#### 1. Slackアプリの設定

1. 以下を参考に設定を実施してください

参考）Slack APIの設定を参考
https://devlog.arksystems.co.jp/2021/07/27/13746/

**トラブルシューティング：**
後続のテストにて`not_in_channel`というメッセージが出た場合は
権限に`chat:write.public`を付与すること

#### 2. メディアタイプの作成
1. 通知 > メディアタイプ に移動します。
2. 「Slack」の「無効」クリックし、「有効」にします

#### 3. マクロの追加
1. 管理 > マクロ をクリックします。
2. 以下を追加する
   1. マクロ：{$ZABBIX.URL}
   2. 値：Zabbixのドメイン

#### 4. Slackにbot_tokenを入れる
1. 通知 > メディアタイプ > Slack をクリックします。
2. 「1. Slackアプリの設定」にて取得したbot_tokenを入れます

#### 5. Zabbixからテストを実行する
1. 通知 > メディアタイプ > Slack の右側にある「テスト」をクリックする
2. テストデータに以下を入れる
   1. channel: 通知するSlackのチャンネル名を記載します
   2. event_id: 任意の数値を記載します
   3. event_source: 0-5の数値を記載します
   4. zabbix_url:ZabbixのURLを入力します
   対象のSlackへ通知されたら成功となります。

#### 7. 通知アクションのアクションの設定
1. 通知 > アクション > トリガーアクション に移動します。
2. 「アクションの作成」をクリックします。
3. 条件とオペレーションを設定し、Slackメディアタイプを使用するように設定します。
4.  「追加」をクリックして保存します。
