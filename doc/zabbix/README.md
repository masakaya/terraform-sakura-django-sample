# Zabbix 7.0 設定マニュアル

## 目次:
1. サーバ自動追加設定
2. Web監視
3. ODBC監視（DB監視）
4. ディスク監視
5. CPU/RAM監視
6. NFS監視（SNMP監視）
7. ログ監視
8. Slack通知

## 1. サーバ自動追加設定

### 前提条件:
- Zabbix 7.0がインストールされていること
- 自動検出ルールを設定するための権限があること

### 手順:

#### 1. アクションの設定(既存ルール有効化)
1. 通知 > アクション > ディスカバリアクション に移動します。
2. 「Auto discovery. Linux servers.」を「無効」をクリックし、「有効」します。

#### 2. 自動検出ルールの作成(既存ルール有効化)
1. データ収集 > ディスカバリ に移動します。
2. ディスカバリルールから「Local network」を無効をクリックし、「有効」とします。

## 2. Web監視

### 前提条件:
- ローカルネットワークから監視対象のWebサイトにアクセスできること

### 手順:

#### 1. Web シナリオの作成
1. データ収集 > ホスト に移動します。
2. 対象のホスト(192.168.0.10)の「Web」リンクをクリックします。
3. 「Web シナリオの作成」をクリックします。
4. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます(例：Web監視(192.168.0.10))
   - 監視間隔: チェックの頻度を設定します(例：1m)
   - 試行回数：1
   - エージェント: Zabbix
5. 「ステップの追加」をクリックします。
6. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます(例：Web監視(192.168.0.10))
   - URL: http://192.168.0.10:81 (※水平スケールした場合は異なるIPを設定すること)
   - 要求ステータスコード：200
   - エージェント: Zabbix
7. 「追加」をクリックして保存します。

## 3. ODBC監視（DB監視）

### 1. 前提条件
- 監視対象のデータベースサーバーが稼働していること
- ODBCドライバーがインストールされていること

1. データ収集 > ホスト > Zabbixサーバーを選択する
2. ホストタブで以下の設定を行う
   1. テンプレート > テンプレートグループ > `Template/Databases` を選択する
   2. `PostgreSQL by ODBC`を選択する
3. テンプレート：`PostgreSQL by ODBC`を選択し、「マクロ」タブから「継承したマクロとテンプレートマクロ」を選択し、以下の設定を行う。
   1. マクロ：`{$PG.CONNSTRING.ODBC}` / 実効値：`Servername=192.168.0.200;Port=5432;Driver=/usr//lib/x86_64-linux-gnu/odbc/psqlodbcw.so`
   2. マクロ：`{$PG.PASSWORD}` / 実行値： `zbx_monitor`ユーザのパスワード
4. 「更新」ボタンをクリックする
5. 監視データ >  最新データ にて「ホスト:`Zabbix server`」にて`DBStat`等の項目が表示されていることを確認する

取得データは以下URLを参照のこと
https://git.zabbix.com/projects/ZBX/repos/zabbix/browse/templates/db/postgresql_odbc

### 3. テストと確認
1. 作成したアイテムの [テスト] ボタンをクリックする
2. テスト結果を確認し、正しく値が取得できることを確認する（`1`という値くること）

### 4. トリガーの設定（オプション）
1. データ収集 > ホスト > トリガーを選択する
2. `トリガーの作成` をクリックする
3. 新規トリガーでは以下を入力する
	1. アイテム :「アイテムの作成にて追加したデータ」
	2. 関数：`last()`
	3. 結果： `<>` `1`
d. [追加] をクリックして保存

### 5. グラフの作成（オプション）
1. データ収集 > ホスト > グラフを選択する
2. 「グラフの作成」 をクリックする
3. 作成したアイテムを選択し、グラフの設定を行う
4. [追加] をクリックして保存

### 7. ダッシュボードへの追加（オプション）
1. 「ダッシュボード」> 「追加」 に移動する
2. ウィジェットの追加で以下のを設定する
	1. タイプ： グラフ
	2. 名前：わかりやすい名前（Ex. DB死活監視)
	3. ホストパターン：データベースサーバーを選択（192.168.1.20）
	4. アイタムパターン：「アイテムの作成にて追加したデータ」
3. 「追加」する

## 4. ディスク監視

### 前提条件:
- 監視対象のサーバにZabbix Agentがインストールされていること
- Linuxテンプレートが適用されていること(自動追加時の設定 Linux Servers. がつくように設定していること)

### 手順:

(事前条件のテンプレートにて監視設定が入っている)

Linux by Zabbix agentにて以下の監視が行われるようになっている。
- クリティカル：90%
- ワーニング  ：80%

## 5. CPU/RAM監視

### 前提条件:
- 監視対象のサーバにZabbix Agentがインストールされていること
- Linuxテンプレートが適用されていること(自動追加時の設定 Linux Servers. がつくように設定していること)

### 手順:

(事前条件のテンプレートにて監視設定が入っている)

Linux by Zabbix agentにてCPU/RAMは以下の監視が行われるようになっている。
- CPU：5分間の平均CPU利用率 90%を超える場合、`警告`を出力する
- RAM：5分間の平均RAM利用率 90%を超える場合、`軽度の障害`を出力する


## 6. NFSディスクサイズ監視

### 前提条件
- 本設定は「さくらのクラウド」のNFSのディスク使用率をチェックするものであり、他のクラウドでは使えないため注意

see: https://manual.sakura.ad.jp/cloud/appliance/nfs/?_gl=1*go7p6m*_gcl_aw*R0NMLjE3MzEyODM5MzguQ2owS0NRaUEwTUc1QmhEMUFSSXNBRWNadHdSeDRHd1R5T3RKdTF1UTJNY0RPdzJ6dnk2NVU5N3ZHMXFmT1pRQ1BOU0xOQkpXRVEzdzEwWWFBbjJNRUFMd193Y0I.*_gcl_au*MTYzNzMxOTA4NC4xNzI4OTY1MjEy#snmp

1. ホストを追加する
   1. 「収集データ > ホスト > ホストの作成」を選択し、以下の設定を入れる
      - ホスト名：NFS
      - 表示名：任意
      - ホストグループ：Linux Server
      - インタフェース：「追加 > SNMP」
        - SNMP：192.168.0.101(NFSのIP) / ポート：161
        - SNMPバージョン：SNMPv2
        - SNMPコミュニティ：{$SNMP_COMMUNITY}
      - マクロタブ：
        - マクロ：{$SNMP_COMMUNITY}／値：`sacloudnfs` (さくらのクラウド固有)
2. アイテムを追加
   1. 「NFS > アイテム」を選択する
   2. 「アイテムの作成」をクリックする
   3. 以下の設定を行う。設定後、テストにて利用率（％）を取得できることを確認する。
      - 名前： 任意
      - タイプ：SNMPエージェント
      - キー：`sakura.nfs.disk.used`
      - データ型：整数型
      - ホストインターフェース：`192.168.0.l01:161`
      - SNMP OID: `get[.1.3.6.1.4.1.2021.9.1.9.1]`
      - 監視感覚：1m
   4. 「追加」ボタンにて追加する

3. トリガーの追加(※Slackへの通知は後述にすること)
   1. 「NFS > トリガー」を選択する
   2. 「トリガーの作成」をクリックする
   3. 以下の設定を行う。
      - 名前：High nfs space usage
      - 深刻度：任意
      - 条件式：`last(/NFS/sakura.nfs.disk.used) > 90` (※90%を超えた場合を想定)
   4. 「追加」ボタンにて追加する
  
4. グラフの追加
   1. 「NFS > グラフ」を選択する
   2. 以下の設定を行う。
      - 名前： NFS space usage(%)
      - アイテム：「追加 > ホスト：NFS Disk Used」
   3. 「追加」ボタンにて追加する

## 7. ログ監視(アプリケーションログ)

### 前提条件:
Zabbix監視サーバーにはsyslogサーバーにて各サーバーからログが収集されること

例：アプリケーションログ(/var/log/rsyslog/app/application.log)を監視する

### 手順（例）:

#### 1. アイテムの作成

ログファイルをZabbixへ取り込む

1. 設定 > ホストに移動し、監視サーバー(Zabbix Server)を選択します。
2. アイテム タブをクリックし、「アイテムの作成」をクリックします。
3. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます
   - タイプ: Zabbixエージェント(アクティブ)
   - キー: logrt[/var/log/rsyslog/app/application.log,,,,,,,,] (監視対象のログファイルパスを指定)
   - 監視間隔：1m
   - ログの時間の形式：`[yyyy-MM-dd hh:mm:ss]`
   - ※細かな設定は以下のURLを参照のこと
https://www.zabbix.com/documentation/current/en/manual/config/items/itemtypes/log_items

4. 「追加」をクリックして保存します。

#### 2. トリガーの設定
1. トリガー タブをクリックし、「トリガーの作成」をクリックします。
2. 以下の設定を行います：
   - 名前: わかりやすい名前を付けます
   - 深刻度：状態に合わせること
   - 式: `find(/Zabbix server/logrt[/var/log/rsyslog/app/application.log,,,,,,,,],,,"error")<>0` ログに`error`が含まれていることを検知する
3. 「追加」をクリックして保存します。

## 8. Slack通知

### 前提条件:
- Slackワークスペースとチャンネルが準備されていること

### 手順:

#### 1. Slackアプリの設定

1. 以下を参考に設定を実施してください

参考）Slack APIの設定を参考
https://devlog.arksystems.co.jp/2021/07/27/13746/

**トラブルシューティング：**
1. 後続のテストにて`not_in_channel`というメッセージが出た場合は
権限に`chat:write.public`を付与すること

#### 2. メディアタイプの作成
1. 通知 > メディアタイプ に移動します。
2. 「Slack」の「無効」クリックし、「有効」にします

#### 3. マクロの追加
1. 管理 > マクロ をクリックします。
2. 以下を追加する
   1. マクロ：{$ZABBIX.URL}
   2. 値：Zabbixのドメイン

#### 4. Slackにbot_tokenを入れる
1. 通知 > メディアタイプ > Slack をクリックします。
2. 「1. Slackアプリの設定」にて取得したbot_tokenを入れます

#### 5. Zabbixからテストを実行する
1. 通知 > メディアタイプ > Slack の右側にある「テスト」をクリックする
2. テストデータに以下を入れる
   1. channel: 通知するSlackのチャンネル名を記載します
   2. event_id: 任意の数値を記載します
   3. event_source: 0-5の数値を記載します
   4. zabbix_url:ZabbixのURLを入力します
   対象のSlackへ通知されたら成功となります。


#### 6. 通知用ユーザを作成する
1. ユーザ > ユーザグループを選択する
2. 「ユーザグループを作成」をクリックする
3. 「テンプレート権限」「ホスト権限」「障害フィルタ」をすべて追加。「テンプレート権限」「ホスト権限」では権限「表示／設定」も合わせていれること
4. ユーザ > ユーザを選択する
5. 「ユーザの作成」を選択する
6. ユーザタブでは以下の設定を行う
   1. ユーザ名：ログインユーザIDを入れる
   2. 名：任意
   3. 姓：任意
   4. グループ：手順1～3で作ったグループを指定する
   5. その他の項目：任意
7. メディアタブでは以下の設定を行う
   1. 「追加」ボタンをクリック
   2. タイプ「Slack」
   3. 有効な時間：任意
   4. 指定した深刻度：任意
   5. 有効：チェック
   6. 「追加」ボタンをクリック
8. 権限タブでは「User role」をクリックする

#### 7. 通知アクションのアクションの設定
1. 通知 > アクション > トリガーアクション に移動します。
2. 「アクションの作成」をクリックします。
3. 条件とオペレーションを設定し、メディアタイプ:Slackを使用するように設定します。
4.  「追加」をクリックして保存します。

※条件は「深刻度」をベースに作成すると良い。

以上